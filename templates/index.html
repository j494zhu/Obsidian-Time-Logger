<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obsidian Logger</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='index_body.css')}}">

    <script src="{{ url_for('static', filename='scripts/rain.js') }}"></script>
</head>
<body>
    
    <div >
        <div class="header-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: rgba(255, 255, 255, 0.808); font-weight: normal">
                {% if readonly %}
                    <span style="color: #2ecc71;">User: {{ display_user.username }} (Read Only)</span>
                {% else %}
                    {{ current_user.username }}'s Log
                {% endif %}
            </h2>

            <div>
                {% if not readonly %}
                    <a href="/history" style="text-decoration: none; color: #ffc011e5; font-weight: 600;">View History</a>
                    <span style="margin: 0 15px; color: #ccc; border-left: 1px solid #ccc; height: 1em; display: inline-block; vertical-align: middle;"></span>
                    <a href="/logout" style="color: #e74c3c; text-decoration: none; font-weight: 600;">Logout</a>
                {% elif current_user.is_authenticated %}
                    <a href="/logout" style="color: #e74c3c; text-decoration: none;">Logout</a>
                {% endif %}
            </div>
        </div>

        <div class="main-layout" style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; align-items: start;">

            <div class="journal-section">
                
                {% if not readonly %}
                    <div class="glass-container mild-white" style="padding: 10px; margin-bottom: 30px">
                        <!--
                        <canvas id="rain-canvas"></canvas>
                        -->
                        
                        <h1 class="section-title">Update your timeline</h1>
                        <div class="form-container" >
                            <form action='/' method='POST'>
                                <label style="font-weight: normal; display: block; margin-bottom: 5px;">Description:</label>

                                <input type="text" name="desc" placeholder="What did you do?" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; background-color: rgba(255, 255, 255, 0); border-color: rgba(255, 255, 255, 0.5)">
                                
                                
                                <label style="font-weight: normal; display: block; margin-bottom: 5px; margin-top: 20px">Duration:</label>
                                <div class="time-inputs-wrapper transp-container">
                                    <div class="time-field">
                                        <label for="start_time" style="color: whitesmoke; font-weight: 200">From</label>
                                        <input type="time" id="start_time" name="start_time" required>
                                    </div>
                                    
                                    <span class="time-separator">â†’</span>
                                    <div class="time-field">
                                        <label for="end_time" style="color: whitesmoke; font-weight: 200">To</label>
                                        <input type="time" id="end_time" name="end_time" required>
                                    </div>
                                </div>
                                <button class="green-button" type="submit" style="margin-top: 15px; width: 100%; padding: 10px; background-color: #48a95aee; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">Add Item</button>
                            </form>
                        </div>
                    </div>
                {% endif %}

                <div class="glass-container mild-white" style="padding: 10px; margin-bottom: 15px">
                    <h1 class="section-title">History Flow</h1>
                        
                    <table class="glass-table">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="50%">Description</th>
                                <th width="15%">Start</th>
                                <th width="15%">End</th>
                                {% if not readonly %}
                                <th width="15%">Oper</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in expenses %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ item.desc }}</td>
                                <td>{{ item.start_time }}</td> 
                                <td>{{ item.end_time }}</td> 
                                {% if not readonly %}
                                <td>
                                    <form action="/delete/{{ item.id }}" method="POST" style="margin:0;">
                                        <button type="submit" class="btn-delete-ghost">Delete</button>
                                    </form>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                            
                            {% if expenses|length == 0 %}
                            <tr>
                                <td colspan="5" class="glass-empty-text">
                                    No records for today yet.
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                {% if not readonly %}
                    {% if not readonly %}
                    <div class="end-day-section" style="margin-top: 40px; margin-bottom: 60px; text-align: center; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 20px;">
                        <p style="color: rgba(255,255,255,0.5); font-size: 0.9em; margin-bottom: 15px;">Ready to wrap up for the day?</p>
                        <form action="/end_day" method="POST" onsubmit="return confirm('End Day? Quick Notes will be cleared.');">
                            <button type="submit" class="red-button">End Day & Archive</button>
                        </form>
                    </div>
                {% endif %}
                {% endif %}
            </div>

            <div class="notes-sidebar">
                <div class="glass-container" style="flex: 1; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                        <h4 class="glass-header-title"># Quick Note</h4>
                        <span id="status-quick" class="glass-header-status">Daily Cleared</span>
                    </div>
                    <textarea id="quick_note_area" class="glass-textarea" {% if readonly %}disabled{% endif %} 
                        placeholder="Write things to clear today...">{{ current_user.quick_note if current_user.is_authenticated else '' }}</textarea>
                </div>

                <div class="glass-container" style="flex: 1; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                        <h4 class="glass-header-title"># NoteBook</h4>
                        <span id="status-book" class="glass-header-status">Permanent</span>
                    </div>
                    <textarea id="notebook_area" class="glass-textarea" {% if readonly %}disabled{% endif %}
                        placeholder="Keep ideas here forever...">{{ current_user.notebook if current_user.is_authenticated else '' }}</textarea>
                </div>
            </div>

        </div>
        </div>

    {% if not readonly %}
    <script>
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function saveNote(type, content, statusId) {
            const statusSpan = document.getElementById(statusId);
            statusSpan.innerText = "Saving...";
            
            fetch('/save_notes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ type: type, content: content }),
            })
            .then(response => response.json())
            .then(data => {
                statusSpan.innerText = "Saved at " + data.saved_at;
            })
            .catch((error) => {
                console.error('Error:', error);
                statusSpan.innerText = "Error!";
            });
        }

        const quickInput = document.getElementById('quick_note_area');
        const bookInput = document.getElementById('notebook_area');

        if(quickInput) {
            quickInput.addEventListener('input', debounce(function() {
                saveNote('quick_note', this.value, 'status-quick');
            }, 1000));
        }

        if(bookInput) {
            bookInput.addEventListener('input', debounce(function() {
                saveNote('notebook', this.value, 'status-book');
            }, 1000));
        }
    </script>
    {% endif %}

</body>
</html>